<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>memory_almost_full</title>
    <style>
      @font-face {
        font-family: "SourceCodePro";
        src: url("assets/SourceCodePro-VariableFont_wght.ttf")
          format("truetype");
      }
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: Arial, sans-serif;
        background-color: #c0d0d0;
      }
      canvas {
        display: block;
        opacity: 0;
        transition: opacity 2s ease-in;
      }

      canvas.fade-in {
        opacity: 1;
      }
      #title {
        position: absolute;
        top: 20px;
        left: 20px;
        color: black;
        font-size: 36px;
        font-weight: bold;
        font-family: "SourceCodePro", monospace;
        z-index: 100;
        text-align: left;
        letter-spacing: 2px;
        text-shadow: 2px 2px 4px rgba(76, 30, 30, 0.454);
      }
    </style>
  </head>
  <body>
    <div id="title">memory_almost_full</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
      // Scene setup
      const scene = new THREE.Scene();
      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      const renderer = new THREE.WebGLRenderer({
        antialias: false, // Disable antialiasing for better performance
        powerPreference: "high-performance", // Use dedicated GPU if available
      });
      renderer.shadowMap.enabled = false; // Disable shadows for better performance
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); // Limit pixel ratio for performance

      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor(0xc0d0d0);
      document.body.appendChild(renderer.domElement);

      // Lighting with shadows
      const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.4);
      directionalLight.position.set(5, 5, 5);
      directionalLight.castShadow = true;
      directionalLight.shadow.mapSize.width = 1024;
      directionalLight.shadow.mapSize.height = 1024;
      scene.add(directionalLight);

      // ASCII art patterns from experiments
      const asciiPatterns = [
        // Simple shapes
        ["  +---+", "  |   |", "  +---+"],
        ["   /\\", "  /  \\", " /____\\"],
        ["  ___", " /   \\", "|     |", " \\___/"],
        ["  *", " ***", "*****", " ***", "  *"],
        ["  []", " [][]", "[][][]", " [][]", "  []"],

        // Tech patterns
        ["[OK]", "LOAD", "RUN"],
        [">--->", ">--->", ">--->"],
        ["[X]", "[X]", "[X]"],
        ["/\\/\\", "\\/\\/", "/\\/\\"],
        ["++++", "++++", "++++"],

        // Abstract patterns
        ["  .", " ...", ".....", " ...", "  ."],
        ["  =", " ===", "=====", " ===", "  ="],
        ["  #", " ###", "#####", " ###", "  #"],
        ["  o", " ooo", "ooooo", " ooo", "  o"],
        ["  *", " ***", "*****", " ***", "  *"],

        // Complex decorative patterns
        [
          "      _.-\\'\\'\\'-._",
          "     .\\'   .-\\'``|\\'.",
          "    /    /    -*- \\\\",
          "   ;   <{      |   ;",
          "   |    _\\\\ |       |",
          "   ;   _\\\\ -*- |    ;",
          "    \\\\   \\\\  | -*-  /",
          "     \\'.\\'_ \\'.\\'__ |_.\\'",
          "        \\'-----\\'",
        ],

        // Star and celestial patterns
        [
          "o                     __...__     *",
          "              *   .--\\'    __.=-.",
          "     |          ./     .-\\'",
          "    -O-        /      /",
          "     |        /    \\'\"/               *",
          "             |     (@)",
          "            |        \\\\",
          "            |         \\\\",
          " *          |       ___\\\\",
          "             |  .   /  `",
          "              \\\\  `~~\\\\",
          "         o     \\\\     \\\\            *",
          "                `\\\\    `-.__",
          "    .             `--._    `--\\'",
          "                       `---~~`                *",
          "            *                   o",
        ],

        // Mechanical/tech patterns
        [
          "         ,",
          "       _=|_",
          "     _[_## ]_",
          "_  +[_[_+_]P/    _    |_       ____      _=--|-~",
          " ~---\\\\_I_I_[=\\\\--~ ~~--[o]--==-|##==]-=-~~  o]H",
          "-~ /[_[_|_]_]\\\\  -_  [[=]]    |====]  __  !j]H",
          '  /    "|"    \\\\      ^U-U^  - |    - ~ .~  U/~',
          " ~~--__~~~--__~~-__   H_H_    |_     --   _H_",
          "-. _  ~~~#######~~~     ~~~-    ~~--  ._ - ~~-=",
          "           ~~~=~~  -~~--  _     . -      _ _ -",
        ],

        // Decorative frame
        [
          "     _____              .---...-.",
          "   ,\\'  -. `.          ,\\' _____...\\'",
          "  /   - _ - \\\\        : .\\' _   _ \\\\",
          " :    \\' _)\\'  :       | :-(_).(_)::",
          "(_           ;)      | |    -\\'  ||",
          "  \\\\     _   /        ; |    _   ||",
          "   `..___..\\'         `-\\'..____.\\'`\\'",
          "      ;._:               _; :_",
          "     /    \\\\ SSt        ,\\'  `\\' `. SSt",
        ],

        // Abstract geometric
        [
          "      `_-@@@-_",
          "|, _ -  -  -   ~-_;",
          " |~ =  . _ .    =   |",
          " |  |   (       )  -",
          "  -__\\\\   _    /,_--",
          "       -_  _-~",
          "       .-\\'--`-_",
          "      ~/    .  |",
          "       |     |~|",
          "       |____(,,)",
          "      /________\\\\",
          "        |_|__|",
          "      _~__~___\\\\",
        ],

        // Cute character
        [
          "   ,_",
          " ,'  `\\,_",
          " |_,-'_)",
          " /##c '\\  (",
          "' |'  -{.  )",
          "  /\\__-' \\[]",
          " /`-_`\\",
          " '     \\",
        ],

        // Dragon scene
        [
          "                                            (",
          "                                           (  )",
          "                     .___.            ,-.  __)",
          "      \\|/           //===\\\\        ,-' o `-!|",
          "    .'+^+`.        //=|_|=\\\\    ,-'---------`-.",
          "  .'///|\\\\\\`.     //=======\\\\    | [+]   [+] |   .-------------.",
          " //////|\\\\\\\\\\   //|||'\"`|||\\\\   |    ___    |  <   huff, puff  >",
          "/((|||^..|||))\\  |||||.^ |||||   |   |   |  //   `--v----------' ",
          " ((|||(oo)|||)   |||||o) |||||   |   |'  |  |..~~~O",
          "                                           {   ~vv'",
          "                                             |",
          "                                            >O<",
        ],

        // Simple geometric
        [
          "    /\\\\    ",
          "   /  \\   ",
          "  /    \\  ",
          " /______\\ ",
          " \\      / ",
          "  \\    /  ",
          "   \\  /   ",
          "    \\/    ",
        ],

        // Fish
        ["     /\\", "  ><(((('>  ", "     \\/"],

        // Building
        [
          "    ____    ",
          "   |    |   ",
          "   | [] |   ",
          "   |____|   ",
          "     ||     ",
        ],

        // Wave pattern
        ["~~~~~~~~~~~", "    ~~~    ", "~~~~~~~~~~~", "    ~~~    "],

        // Tower
        [
          "    |||||    ",
          "    |||||    ",
          "   _|||||_   ",
          "  |_______|  ",
          "     |||     ",
          "     |||     ",
        ],

        // Mona Lisa
        [
          " ________________________",
          "|.----------------------.|",
          "||                      ||",
          "||       ______         ||",
          "||     .;;;;;;;;.       ||",
          "||    /;;;;;;;;;;;\     ||",
          "||   /;/`    `-;;;;; . .||",
          "||   |;|__  __  \;;;|   ||",
          "||.-.|;| e`/e`  |;;;|   ||",
          "||   |;|  |     |;;;|'--||",
          "||   |;|  '-    |;;;|   ||",
          "||   |;;\ --'  /|;;;|   ||",
          "||   |;;;;;---'\\|;;;|   ||",
          "||   |;;;;|     |;;;|   ||",
          "||   |;;.-'     |;;;|   ||",
          "||'--|/`        |;;;|--.||",
          "||;;;;    .     ;;;;.\\;;||",
          "||;;;;;-.;_    /.-;;;;;;||",
          "||;;;;;;;;;;;;;;;;;;;;;;||",
          "||jgs;;;;;;;;;;;;;;;;;;;||",
          "'------------------------'",
        ],

        // Venus de Milo
        [
          "    %%%",
          "   =====",
          "  &%&%%%&",
          "  %& < <% ",
          "   &\\__/",
          "    \\ |____",
          "   .', ,  ()",
          "  / -.  _)| ",
          " |_(_.    |",
          " '-'\\  )  |",
          " mrf )    |",
          "    /  .  ).",
          "   /    _. |",
          " /'---':.-.'|",
          "(__.' /    /",
          " \\   ( /  /",
          "  \\ /  _  | ",
          "   \\  |  '|",
          "   | . \\  |",
          "   |(     | ",
          "   |  \\ \\ |",
          "    \\  )\\ |",
          "   __)/ / \\",
          "--\"--(_.Ooo'----",
        ],

        // Random pal
        [
          "             __",
          "           .'  `'.",
          "          /  _    |",
          "          #_/.\\==/.\\ ",
          "         (, \\_/ \\_/",
          "          |    -' |",
          "          \\   '=  /",
          "          /`-.__.' ",
          "       .-'`-.___|__",
          "     /    \\       `.",
        ],

        // Gameboy
        [
          "     _______",
          "    |.-----.|",
          "    ||     ||",
          "    ||_____/|",
          "    | .     |",
          "    |-|-  oo|",
          "    |  _ _  |",
          "    |       /",
          '    `""""""`',
        ],

        // Man in boat
        [
          "                                \\",
          "                                  \\   O,",
          "                        \\___________\\/ )_________/",
          "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ \\~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~",
        ],

        // Train
        [
          "    ooOOOO",
          "   oo      _____",
          "  _I__n_n__||_|| ________",
          ">(_________|_7_|-|______|",
          " /o ()() ()() o   oo  oo",
        ],

        // Rocket ship
        [
          "                  _______ ______",
          "                  |     / |    /",
          "       O          |    /  |   /",
          "                  |   /   |  /",
          "    o  O 0         \\  \\   \\  \\",
          "    o               \\  \\   \\  \\",
          "       o            /  /   /  /",
          "        o     /\\_  /\\\\\\   /  /",
          "         O  /    /    /     /",
          " ..       /    /    /\\=    /",
          ".  ))))))) = /====/    \\",
          ". (((((((( /    /\\=  _ }",
          ". |-----_|_+( /   \\}",
          ". \\_<\\_//|  \\  \\ }",
          " ...=Q=  |==)\\  \\",
          "   \\----/     ) )",
          "             / /",
          "            /=/",
          "          \\|/",
          "          o}",
        ],

        // Trash can
        [
          "   |\\_",
          "  /  .\\_",
          " |   ___)",
          " |    \\",
          " |  =  |",
          " /_____\\",
          "[_______]",
        ],

        // Dancing figures
        [
          " o__         __o        ,__o        __o           __o",
          " ,>/_       -\\<,      _-\\_<,       _`\\<,_       _ \\<_",
          "(*)`(*).....O/ O.....(*)/(*).....(*)/ (*).....(_)/(_)",
        ],

        // Lighthouse scene
        [
          "        .n.                     |",
          "       /___\\          _.---.  \\ _ /",
          "       [|||]         (_._ ) )--;_) =-",
          "       [___]           '---'.__,' \\",
          "       }-=-{                    |",
          '       |-" |',
          '       |.-"|                p',
          "~^=~^~-|_.-|~^-~^~ ~^~ -^~^~|\\ ~^-~^~-",
          "^   .=.| _.|__  ^       ~  /| \\",
          ' ~ /:. \\" _|_/\\    ~      /_|__\\  ^',
          '.-/::.  |   |""|-._ ^   ~~~~',
          "  `===-'-----'\"`  '-.              ~",
          "                 __.-'      ^",
        ],

        // Owl
        [
          "       o        o",
          "  ___   \\      /   ___",
          ".` __`-. \\/\\/\\/ .-'__ '.",
          "( /  \\  \\/(..)\/  /  \\ )",
          "\\ \\ O ) ( (oo) ) ( O / /",
          " \\ \\_/ __>----<__ \\_/ /",
          '  ".   >_      _<   ."',
          "    >   /      \\   <",
          "   / /( \\      / )\\ \\",
          '  / `" _/ ____ \\_ "\' \\',
          "  \\_.-` A/  & \\A '-._/",
        ],

        // Decorative face
        [
          ".==-.                   .-==.",
          " \\()8`-._  `.   .'  _.-'8()/",
          ' (88"   ::.  \\./  .::   "88)',
          "  \\_.'`-::::.(#).::::-'`._/",
          "    `._... .q(_)p. ..._'",
          '      ""-..-.\'|=|`-..-""',
          '      .""\' .\'|=|`. `"".',
          "    ,':8(o)./|=|\\.(o)8:`.",
          "   (O :8 ::/ \\_/ \\:: 8: O)",
          "    \\O `::/       \\::' O/",
          '     ""--\'         `--""',
        ],

        // Simple face
        [
          "    .----.   @   @",
          '   / .-"-.\`.  \\v/',
          "   | | '\\ \\ \\_/ )",
          " ,-\\ `-.' /.'  /",
          "'---`----'----'",
        ],

        // Caterpillar
        [
          "    \\_/-.--.--.--.--.--.",
          '    (")__)__)__)__)__)',
          '     ^ "" "" "" "" "" ""',
        ],

        // Simple stick figure
        ['\\(")/', "-( )-", "/(_)\\"],

        // Dinosaur
        [
          "                     .",
          "                    / V\\",
          "                  / `  /",
          "                 <<   |",
          "                 /    |",
          "               /      |",
          "             /        |",
          "           /    \\  \\ /",
          "          (      ) | |",
          "  ________|   _/_  | |",
          "<__________\\______)\\___)",
        ],

        // Cat
        [
          "    =/\\                 /\\=",
          "    / \\._   (\\_/)   _./\\",
          "   / .''._'--(o.o)--'_.''\\",
          "  /.' _/ |`=/ \" \\=`| \\_ `.\\",
          " /` .' \\;-,'\\___/',-;/ `. '\\",
          "/.-'      `\\(-V-)/`       `-.\\",
          '`            "   "',
        ],

        // Pig
        [
          "             ___",
          '          .="   "=._.---.',
          '        ."         c  Y p',
          "       /   ,       `.  w_/",
          "       |   -.   /     /",
          " _,..._|      )_-\\ \\_=.\\",
          '`-....- `------))) =- " ',
        ],

        // Car
        [
          "                                  .-.",
          "     (___________________________()6 `-,",
          '     (   ______________________   / "`',
          "     //\\\\                      //\\\\",
          '     "" ""                     "" ""',
        ],
      ];

      // ASCII pattern elements system
      const patternCount = 25; // Reduced count for better performance
      const patternElements = [];
      const patternVelocities = [];
      const patternRotations = [];

      // Create ASCII pattern elements
      for (let i = 0; i < patternCount; i++) {
        const pattern =
          asciiPatterns[Math.floor(Math.random() * asciiPatterns.length)];
        const maxWidth = Math.max(...pattern.map((line) => line.length));
        const maxHeight = pattern.length;

        // Create a group to hold all the text sprites for this pattern
        const patternGroup = new THREE.Group();

        // Create individual text sprites for each character in the pattern
        const patternSprites = [];
        let charIndex = 0;

        for (let row = 0; row < pattern.length; row++) {
          const line = pattern[row];
          for (let col = 0; col < line.length; col++) {
            const char = line[col];

            // Create canvas for this character
            const canvas = document.createElement("canvas");
            const context = canvas.getContext("2d");
            canvas.width = 64;
            canvas.height = 64;

            // Set font and style
            context.font = "32px SourceCodePro, monospace";
            context.fillStyle = "rgba(60, 60, 60, 0.8)";
            context.textAlign = "center";
            context.textBaseline = "middle";

            // Draw character
            context.fillText(char, 32, 32);

            // Create texture and sprite
            const texture = new THREE.CanvasTexture(canvas);
            const spriteMaterial = new THREE.SpriteMaterial({
              map: texture,
              transparent: true,
              opacity: 0.8,
              alphaTest: 0.1,
            });

            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(0.5, 0.5, 1);

            // Position character within pattern
            sprite.position.set(
              (col - maxWidth / 2) * 0.6,
              (maxHeight / 2 - row) * 0.6,
              0
            );

            patternGroup.add(sprite);
            patternSprites.push(sprite);
            charIndex++;
          }
        }

        // Random position in 3D space
        patternGroup.position.set(
          (Math.random() - 0.5) * 60,
          (Math.random() - 0.5) * 40,
          (Math.random() - 0.5) * 60
        );

        // Random initial rotation
        patternGroup.rotation.set(
          (Math.random() - 0.5) * Math.PI,
          (Math.random() - 0.5) * Math.PI,
          (Math.random() - 0.5) * Math.PI
        );

        // Store pattern data
        patternElements.push({
          group: patternGroup,
          sprites: patternSprites,
          pattern: pattern,
          maxWidth: maxWidth,
          maxHeight: maxHeight,
        });

        // Random velocities for floating and jittering motion
        patternVelocities.push({
          x: (Math.random() - 0.5) * 0.01,
          y: (Math.random() - 0.5) * 0.01,
          z: (Math.random() - 0.5) * 0.01,
          rotationX: (Math.random() - 0.5) * 0.002,
          rotationY: (Math.random() - 0.5) * 0.002,
          rotationZ: (Math.random() - 0.5) * 0.002,
          jitterX: (Math.random() - 0.5) * 0.005,
          jitterY: (Math.random() - 0.5) * 0.005,
          jitterZ: (Math.random() - 0.5) * 0.005,
        });

        // Store base positions for jittering
        patternRotations.push({
          baseX: patternGroup.position.x,
          baseY: patternGroup.position.y,
          baseZ: patternGroup.position.z,
          time: Math.random() * Math.PI * 2,
        });

        scene.add(patternGroup);
      }

      // Artist images as billboard planes
      const artistImages = [
        {
          name: "Anat Saacks",
          path: "assets/Artists/Anat Saacks/Anat Saacks.jpg",
        },
        {
          name: "Chenn Hearthstone",
          path: "assets/Artists/Chenn Hearthstone/Chenn Hearthstone_placeholder.png",
        },
        {
          name: "Dafna Sartiel",
          path: "assets/Artists/Dafna Sartiel/Dafna_Sartiel.jpg",
        },
        {
          name: "Eitan Bartal",
          path: "assets/Artists/Eitan Bartal/EitanBartal_placeholder.png",
        },
        {
          name: "Eyal Datz",
          path: "assets/Artists/Eyal Datz/Eyal Datz_placeholder.png",
        },
        {
          name: "Eyal Yehowa Gruss",
          path: "assets/Artists/Eyal Yehowa Gruss/Eyal Yehowa Gruss_placeholder.png",
        },
        {
          name: "Gilad Friedman",
          path: "assets/Artists/Gilad Friedman/Gilad Fridman.jpg",
        },
        {
          name: "Haya Sheffer",
          path: "assets/Artists/Haya Sheffer/Haya Sheffer.jpg",
        },
        {
          name: "Naama Steinbock",
          path: "assets/Artists/Naama Steinbock/Naama Steinbock.jpg",
        },
        {
          name: "Oded Ezer",
          path: "assets/Artists/Oded Ezer/Oded Ezer_placeholder.png",
        },
        {
          name: "Ofir Liberman",
          path: "assets/Artists/Ofir Liberman/ofir_liberman.jpg",
        },
        {
          name: "Rony Ginosar",
          path: "assets/Artists/Rony Ginosar/Rony Ginosar.jpg",
        },
        {
          name: "Shaul Tzemach",
          path: "assets/Artists/Shaul Tzemach/fbm_b134006708485641932.png",
        },
        {
          name: "Yoav Ruda",
          path: "assets/Artists/Yoav Ruda/Yoav Ruda_placeholder.png",
        },
        {
          name: "Yonatan Ben-Simhon and Mattan Tenne",
          path: "assets/Artists/Yonatan Ben-Simhon and Mattan Tenne/yonatan ben-simhon.jpeg",
        },
        {
          name: "Yuval Keshet",
          path: "assets/Artists/Yuval Keshet/Yuval Keshet.JPG",
        },
      ];

      const imagePlanes = [];
      const textureLoader = new THREE.TextureLoader();
      const connectionLines = [];

      // Preload all images in parallel for faster loading
      function preloadImages() {
        const loadPromises = artistImages.map((artist) => {
          return new Promise((resolve, reject) => {
            const texture = textureLoader.load(
              artist.path,
              (loadedTexture) => {
                // Optimize texture settings for better performance
                loadedTexture.generateMipmaps = false;
                loadedTexture.minFilter = THREE.LinearFilter;
                loadedTexture.magFilter = THREE.LinearFilter;
                loadedTexture.format = THREE.RGBAFormat;
                loadedTexture.flipY = true;

                resolve({ artist, texture: loadedTexture });
              },
              undefined,
              (error) => {
                console.warn(`Failed to load image: ${artist.path}`, error);
                reject(error);
              }
            );
          });
        });

        return Promise.all(loadPromises);
      }

      // Create all image planes after preloading
      preloadImages()
        .then((loadedTextures) => {
          loadedTextures.forEach(({ artist, texture }) => {
            // Calculate aspect ratio from loaded texture
            const aspectRatio = texture.image.width / texture.image.height;
            const baseHeight = 2.5;
            const width = baseHeight * aspectRatio;

            // Create geometry with proper aspect ratio
            const geometry = new THREE.PlaneGeometry(width, baseHeight);

            const material = new THREE.MeshBasicMaterial({
              map: texture,
              transparent: true,
              opacity: 0.95,
              side: THREE.DoubleSide,
              alphaTest: 0.1, // Optimize transparency rendering
            });

            const plane = new THREE.Mesh(geometry, material);

            // Random position in 3D space
            plane.position.set(
              (Math.random() - 0.5) * 30,
              (Math.random() - 0.5) * 20,
              (Math.random() - 0.5) * 30
            );

            // Ensure images render in front of lines
            plane.renderOrder = 1;

            // Store reference for billboard behavior
            plane.userData = { isBillboard: true };
            imagePlanes.push(plane);
            scene.add(plane);
          });

          // Create connections after all images are loaded
          createConnections();

          // Trigger fade-in effect once everything is loaded
          setTimeout(() => {
            renderer.domElement.classList.add("fade-in");
            // Start rotation animation after fade-in begins
            rotationStartTime = Date.now();
            isRotating = true;
          }, 100); // Small delay to ensure everything is rendered
        })
        .catch((error) => {
          console.error("Error loading images:", error);
          // Still trigger fade-in even if some images fail to load
          setTimeout(() => {
            renderer.domElement.classList.add("fade-in");
            // Start rotation animation after fade-in begins
            rotationStartTime = Date.now();
            isRotating = true;
          }, 100);
        });

      // Function to create connections between images (optimized)
      function createConnections() {
        // Reduce number of connections for better performance
        const maxConnections = Math.min(imagePlanes.length * 0.5, 20); // Limit total connections
        let connectionCount = 0;

        for (
          let i = 0;
          i < imagePlanes.length && connectionCount < maxConnections;
          i++
        ) {
          // Each image connects to 1-2 other images (reduced from 1-3)
          const numConnections = Math.floor(Math.random() * 2) + 1;
          const connectedIndices = new Set();

          // Ensure we don't connect to the same image
          while (
            connectedIndices.size < numConnections &&
            connectedIndices.size < imagePlanes.length - 1 &&
            connectionCount < maxConnections
          ) {
            const randomIndex = Math.floor(Math.random() * imagePlanes.length);
            if (randomIndex !== i) {
              connectedIndices.add(randomIndex);
            }
          }

          // Create lines to connected images
          connectedIndices.forEach((targetIndex) => {
            if (connectionCount >= maxConnections) return;

            const startPos = imagePlanes[i].position;
            const endPos = imagePlanes[targetIndex].position;

            // Create line geometry
            const points = [
              new THREE.Vector3(startPos.x, startPos.y, startPos.z),
              new THREE.Vector3(endPos.x, endPos.y, endPos.z),
            ];

            const geometry = new THREE.BufferGeometry().setFromPoints(points);

            // Create line material with optimized settings
            const material = new THREE.LineBasicMaterial({
              color: 0x666666,
              transparent: true,
              opacity: 0.4,
              linewidth: 1,
              depthTest: true,
              depthWrite: false,
              vertexColors: false, // Disable vertex colors for performance
            });

            const line = new THREE.Line(geometry, material);
            line.renderOrder = -1; // Render before other objects
            line.frustumCulled = true; // Enable frustum culling
            connectionLines.push(line);
            scene.add(line);
            connectionCount++;
          });
        }
      }

      // Camera position
      camera.position.z = 15;

      // Simplified orbit controls
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.enableZoom = true;
      controls.enablePan = true;

      // Performance optimization variables
      let frameCount = 0;
      const updateFrequency = 2; // Update sprites every 2 frames instead of every frame
      const frustum = new THREE.Frustum();
      const cameraMatrix = new THREE.Matrix4();

      // Rotation animation variables
      let rotationStartTime = null;
      const rotationDuration = 3000; // 3 seconds in milliseconds
      let isRotating = false;

      // Easing function for smooth rotation (ease-in-out)
      function easeInOutCubic(t) {
        return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
      }

      // Optimized animation loop
      function animate() {
        requestAnimationFrame(animate);
        frameCount++;

        // Update camera matrix for frustum culling
        cameraMatrix.multiplyMatrices(
          camera.projectionMatrix,
          camera.matrixWorldInverse
        );
        frustum.setFromProjectionMatrix(cameraMatrix);

        // Update ASCII pattern positions with jittering motion (reduced frequency for performance)
        if (frameCount % updateFrequency === 0) {
          for (let i = 0; i < patternCount; i++) {
            const patternElement = patternElements[i];
            const velocity = patternVelocities[i];
            const rotation = patternRotations[i];
            const group = patternElement.group;

            // Update time for jittering
            rotation.time += 0.02;

            // Calculate jittering offset using sine waves for smooth motion
            const jitterOffsetX =
              Math.sin(rotation.time * 0.7) * velocity.jitterX;
            const jitterOffsetY =
              Math.sin(rotation.time * 0.9) * velocity.jitterY;
            const jitterOffsetZ =
              Math.sin(rotation.time * 0.5) * velocity.jitterZ;

            // Update positions with floating and jittering motion
            group.position.x =
              rotation.baseX + jitterOffsetX + velocity.x * updateFrequency;
            group.position.y =
              rotation.baseY + jitterOffsetY + velocity.y * updateFrequency;
            group.position.z =
              rotation.baseZ + jitterOffsetZ + velocity.z * updateFrequency;

            // Update base positions for floating motion
            rotation.baseX += velocity.x * updateFrequency;
            rotation.baseY += velocity.y * updateFrequency;
            rotation.baseZ += velocity.z * updateFrequency;

            // Boundary checking - wrap around instead of bounce
            if (Math.abs(rotation.baseX) > 30) {
              rotation.baseX = rotation.baseX > 0 ? -30 : 30;
            }
            if (Math.abs(rotation.baseY) > 20) {
              rotation.baseY = rotation.baseY > 0 ? -20 : 20;
            }
            if (Math.abs(rotation.baseZ) > 30) {
              rotation.baseZ = rotation.baseZ > 0 ? -30 : 30;
            }

            // Add subtle rotation to pattern groups
            group.rotation.x += velocity.rotationX * updateFrequency;
            group.rotation.y += velocity.rotationY * updateFrequency;
            group.rotation.z += velocity.rotationZ * updateFrequency;

            // Make patterns face the camera (billboard effect)
            group.lookAt(camera.position);
          }
        }

        // Handle rotation animation
        if (isRotating && rotationStartTime !== null) {
          const currentTime = Date.now();
          const elapsed = currentTime - rotationStartTime;
          const progress = Math.min(elapsed / rotationDuration, 1);

          if (progress < 1) {
            // Apply easing and rotate around Y-axis
            const easedProgress = easeInOutCubic(progress);
            const rotationAngle = (easedProgress * Math.PI) / 4; // Rotate 45 degrees (π/4 radians) to the left

            // Rotate the entire scene around Y-axis
            scene.rotation.y = rotationAngle;
          } else {
            // Animation complete
            isRotating = false;
            scene.rotation.y = Math.PI / 4; // Final rotation position
          }
        }

        // Optimized billboard behavior with frustum culling
        imagePlanes.forEach((plane) => {
          // Only update billboard behavior if plane is in view
          if (frustum.intersectsObject(plane)) {
            plane.lookAt(camera.position);
            plane.visible = true;
          } else {
            plane.visible = false; // Hide objects outside frustum
          }
        });

        controls.update();
        renderer.render(scene, camera);
      }

      // Optimized window resize handler
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Start animation
      animate();
    </script>
  </body>
</html>
